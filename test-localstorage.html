<!DOCTYPE html>
<html>
<head>
    <title>LocalStorage JWT Test</title>
</head>
<body>
    <h1>LocalStorage JWT Test</h1>
    <div id="output"></div>
    
    <script>
        async function testLogin() {
            const output = document.getElementById('output');
            
            try {
                // Test login
                const response = await fetch('http://localhost:8080/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: 'ckent@example.com',
                        password: 'password123',
                    }),
                });
                
                if (response.ok) {
                    const data = await response.json();
                    output.innerHTML += '<p style="color: green;">✅ Login successful!</p>';
                    output.innerHTML += '<p>Response: ' + JSON.stringify(data) + '</p>';
                    
                    // Store token in localStorage
                    if (data.token) {
                        localStorage.setItem('jwt_token', data.token);
                        output.innerHTML += '<p style="color: green;">✅ Token stored in localStorage!</p>';
                        
                        // Test reading from localStorage
                        const storedToken = localStorage.getItem('jwt_token');
                        if (storedToken) {
                            output.innerHTML += '<p style="color: green;">✅ Token retrieved from localStorage!</p>';
                            output.innerHTML += '<p>Token: ' + storedToken.substring(0, 50) + '...</p>';
                            
                            // Parse token
                            const parts = storedToken.split('.');
                            if (parts.length === 3) {
                                const base64Url = parts[1];
                                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                                const paddedBase64 = base64 + '='.repeat((4 - base64.length % 4) % 4);
                                const payload = JSON.parse(atob(paddedBase64));
                                
                                output.innerHTML += '<h3>Token Payload:</h3>';
                                output.innerHTML += '<pre>' + JSON.stringify(payload, null, 2) + '</pre>';
                                
                                const userid = payload.user_id || payload.userid || payload.id;
                                const username = payload.username || payload.user || payload.name;
                                
                                output.innerHTML += '<h3>Extracted User Info:</h3>';
                                output.innerHTML += '<p>User ID: ' + userid + '</p>';
                                output.innerHTML += '<p>Username: ' + username + '</p>';
                            }
                        }
                    } else {
                        output.innerHTML += '<p style="color: red;">❌ No token found in response</p>';
                    }
                } else {
                    output.innerHTML += '<p style="color: red;">❌ Login failed: ' + response.status + '</p>';
                }
            } catch (error) {
                output.innerHTML += '<p style="color: red;">❌ Error: ' + error.message + '</p>';
            }
        }
        
        // Run test on load
        testLogin();
    </script>
</body>
</html>
